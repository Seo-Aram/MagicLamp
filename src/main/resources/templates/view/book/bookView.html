<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Board View</title>
    <script src="https://code.jquery.com/jquery-1.12.4.js"
            integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU=" crossorigin="anonymous"></script>
    <link href="/css/review.css" rel="stylesheet">
</head>
<body>
<!--내비게이션 시작-->
<!--내비게이션 끝-->

<!-- 도서 상세 보기 시작-->

<table style="margin-left:auto; margin-right:auto; width: 890px">
    <tr>
        <td>
            <!--상단 타이틀 (&저자,출판사,출간일) 시작-->
            <div>
                <ul>
                    <li>
                        <div>
                            <span th:text="${bookView.title}"></span>
                        </div>
                    </li>
                    <li>
                        <div>
                            <span th:text="${bookView.author + ' | ' + bookView.publisher + ' | ' + bookView.pubdate }"></span>
                        </div>
                    </li>
                </ul>
            </div>
            <hr/>
            <!--상단 타이틀 (&저자,출판사,출간일) 끝-->

            <!--도서이미지 시작-->
            <div style="display: inline; width: 300px">

                <div th:if="${bookView.bookimg.length() > 0}" style="display: inline; width: 300px">
                    <img th:src="@{/photo/{name}(name=${bookView.bookimg})}" width="300px">
                </div>
                <div th:unless="${bookView.bookimg.length() > 0}" style="display: inline; width: 300px">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAADICAMAAAA9W+hXAAAAQlBMVEX9/f3///++vr7f39/j4+Pb29ugoKDBwcHv7+9+fn7Hx8fOzs7KysrS0tL39/fz8/OHh4eYmJiPj4+xsbGpqanp6elktXx4AAAEtUlEQVR4nO2bC2/rKBBGMW/ztJ3L//+rOwMkdpLuStWujVeao6vWl6TyEXwehqhljCAIgiAIgiAIgiAIgiAIgiAIgiAIgiB+j82jDb6RkXN+Ny/pOHeB29Eeb6BUtJO4lZZFqTRN47SSrRwjlCBTPk1JpCFaSUaYlSfOq+ZmDXdlQjcJWtxFma6Uqko+ikr0BtUkY4pzxRj6SFzEUJXPE5s+sHDffBxIBSYoBG7sVBw3cmrZmjLE337+9HSOVhKKi697JQ9ijEWcsOmphV+VSFdoZVwy0JLR11UK3ouCd+acZccdyCRlCgj5upScm3yBluMxolaNF2Bq6iMOTB6nCsNlbBVCLXi3u0ALclUXMb/WJlnhq+eUYF4wXIKhUMl1ESFfF2p9gZMz7eF6ZetaLWZLKxDFppdWMTxYfI2BkGQDtMxeTrmJpWqp+jAwYeAbJmyAlhSibT5SQMX3Tcu1cOE6otDobKXUs1Xrl0rjsvVF1ZIQrlamBmmp8ExWgHrKWoHwbecpPuOeqIZE3ndqYe3lNKQWrjIq8sf7FNGexCL3cN0qWzhJ3g7MVpZC4RJC19XqKWrl0MLVCumIzYcfcW1PLLVlnqxv3SkfoFWKrZUgwSbkTesgounhqk+iKvfJFrY1wY7LFs5TO/kcteA8Bi3gNE4rHJLlRdt88JAR4e25Hsh4GKAVnycfhQ1qK6exTtXzQBbi4Gyl0sqpxJ4ZZsyVu5XT8gzXIC2p6nYIX5SwrGu9HciG9Fu9eeipV1WrH8i61pByml/H5Qz1VO0HspeWvMvJJx0OqveK/GsK4/20ksDPdG6mlRSe/kvvum6iheW0nvanO2nB0WeXGqGFB1fEWvbSgu6U+/YhgLTXZ8srd2xO4bDPUEvwd5zyl2rVbiZGhcTo8PMIGMSSb9xr2Ff1q7SMFM4r+YZqn76Z73EnIG0XaEUO8/ENehn/0ysOPyo8XYt5/ks8u0ALN+lf8fGB7mla/xbSIi3SIi3SIi3SIq1xWgRB3B8tX5fG/jR6MWZZDHybFQsGCPslXMPlGMIS4F910doYrbvWYx6qpTljvLlomDXTLhlTM746TAtvjAqfWnHOd9R6zGGk1gZ3D9uXVl74lgdqPcBDPz618qrz+sjjtOyybYttWjNQtewKQ3JZx2mxbMxHuOGyVtQsB2rtLv98OYabaqm7/V488b9DqsbeSAX+PmqV7aOHN3TMWb89z7Xe5lVD4yA1/jfUwr6PMr7o5dHKfZeAS1v7L3vqk6ln7Pta6wIbDgpA7VyXP/g9LhLqe9z37Kql5rO17J8lLljYj1o2bKtatmCbZB89arUfPksr63mF6VhnndWstV6qQF42g9vQNue/m62uZU7yCi3rMsCtIONr1ZKxRz5K9tiz9YPWqk+xgmx3+GERcXSd6+jzSVThykWslQCWAmrBR+TN85b4Vw+tKmDjpYJ6aql4XuT3WThkCyOH8/XAjREPQP0INM+L/tO0AGgNT9Pa61GuaWrPnsEOmWUM/kHr8COd87RW1XWOdw3w7DF4CnH99ANff1yrFXriw/tdw4oNcx3sTwV/f8PJWgRBEARBEARBEARBEARBEARBEARBEATxX/AXA2NChMzAFEkAAAAASUVORK5CYII="
                         width="300px">
                </div>
            </div>
            <!--도서이미지 끝-->

            <!--도서 상품정보 시작-->
            <div style="display: inline-block; vertical-align: top">
                <ul>
                    <li>
                        <div style="display: inline">정가</div>
                        <div style="display: inline">[[${#numbers.formatInteger(bookView.price, 0, 'COMMA')}]]원</div>
                    </li>
                    <li>
                        <div style="display: inline">판매가</div>
                        <div style="display: inline">[[${#numbers.formatInteger(bookView.saleprice, 0, 'COMMA')}]]원
                            (10%, [[${#numbers.formatInteger(bookView.price-bookView.saleprice, 0, 'COMMA')}]]원 할인)
                        </div>
                    </li>
                    <li>
                        <div style="display: inline">마일리지</div>
                        <div style="display: inline">[[${#numbers.formatInteger(bookView.price*bookView.mileagerate/100,
                            0, 'COMMA')}]]원 (5%)
                        </div>
                    </li>
                    <li>
                        <th:block th:if="${bookViewAlpha.star > 0}">
                            <th:block th:if="${bookViewAlpha.star == 5}">★★★★★</th:block>
                            <th:block th:if="${bookViewAlpha.star == 4}">★★★★☆</th:block>
                            <th:block th:if="${bookViewAlpha.star == 3}">★★★☆☆</th:block>
                            <th:block th:if="${bookViewAlpha.star == 2}">★★☆☆☆</th:block>
                            <th:block th:if="${bookViewAlpha.star == 1}">★☆☆☆☆</th:block>
                            <span th:text="${'(' + bookViewAlpha.cnt + ')'}"></span>
                        </th:block>
                    </li>
                    <li>
                        <div style="display: inline">수량</div>
                        <div style="display: inline">
                            <input type="text" name="qty" id="result" min="0" value="1">
                            <input type="button" onclick="count('plus')" value="+"/>
                            <input type="button" onclick="count('minus')" value="-"/>
                        </div>
                    </li>
                    <li>
                        <div style="display: inline">총 상품금액</div>
                        <div style="display: inline">
                            <span id="totalPrice">
                                [[${#numbers.formatInteger(bookView.saleprice, 0, 'COMMA')}]]원
                            </span>
                        </div>
                    </li>
                    <li>
                        <div style="display: inline">
                            <button onclick="insertOneCart(this)" id="bookIsbn" th:value="${bookView.isbn}">장바구니 담기
                            </button>
                        </div>
                        <div style="display: inline">
                            <a class="btn_buy" th:href="@{/order(isbn=${bookView.isbn}, bookcount=${1})}" id="dirQty">
                                <button>바로구매</button>
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
            <hr/>
            <div>
                <h3>기본 정보</h3>
                <div th:text="${bookView.pages + '쪽 | ' + bookView.size + ' | ' + bookView.weight + 'g | ISBN: ' + bookView.isbn + ' | 도서형태: ' + bookView.binding}"></div>
                <div th:text="${'주제 분류: ' + bookView.category}"></div>
            </div>
            <hr/>
            <div>
                <h3>책 소개</h3>
                <div th:text="${bookView.description}"></div>
            </div>
            <hr/>
            <div>
                <h3>목차</h3>
                <div th:text="${bookView.contents}"></div>
            </div>
            <!--도서 상품정보 끝-->
        </td>
    </tr>
</table>
<!-- 도서 상세 보기 끝-->

<!-- 리뷰 영역 -->
<article>
    <div class="review_title">
        <h3 class="title_text">리뷰</h3>
    </div>
    <div id="review_info_section">
        <div class="review_input_left">
            <h4 class="buyer_score_title">구매자 별점</h4>
            <p class="buyer_score">
                <span class="score" th:text="${avg}" th:if="${avg != null}"></span>
                <span class="score" th:text="0.0" th:unless="${avg != null}"></span>
            </p>
            <div class="StarRate_Icon">
                <p class="StarRate_IconFill" th:styleappend="'width:'+${avg*20}+'%'" th:if="${avg != null}"></p>
                <p class="StarRate_IconFill" th:styleappend="'width:0%'" th:unless="${avg != null}"></p>
            </div>
            <div class="score_graph">
                <table>
                    <tbody>
                    <tr>
                        <td>
                            ★ 5
                        </td>
                        <td>
                            <div class="bar-container">
                                <div class="bar-5" th:styleappend="'width:'+${(star5 * 100) / people}+'%'"
                                     th:if="${star5 != 0}"></div>
                                <div class="bar-5" th:styleappend="'width:0%'" th:unless="${star5 != 0}"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ★ 4
                        </td>
                        <td>
                            <div class="bar-container">
                                <div class="bar-4" th:styleappend="'width:'+${(star4 * 100) / people} + '%'"
                                     th:if="${star4 != 0}"></div>
                                <div class="bar-4" th:styleappend="'width:0%'" th:unless="${star4 != 0}"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ★ 3
                        </td>
                        <td>
                            <div class="bar-container">
                                <div class="bar-3" th:styleappend="'width:'+${(star3 * 100) / people} + '%'"
                                     th:if="${star3 != 0}"></div>
                                <div class="bar-3" th:styleappend="'width:0%'" th:unless="${star3 != 0}"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ★ 2
                        </td>
                        <td>
                            <div class="bar-container">
                                <div class="bar-2" th:styleappend="'width:'+${(star2 * 100) / people} + '%'"
                                     th:if="${star2 != 0}"></div>
                                <div class="bar-2" th:styleappend="'width:0%'" th:unless="${star2 != 0}"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            ★ 1
                        </td>
                        <td>
                            <div class="bar-container">
                                <div class="bar-1" th:styleappend="'width:'+${(star1 * 100) / people} + '%'"
                                     th:if="${star1 != 0}"></div>
                                <div class="bar-1" th:styleappend="'width:0%'" th:unless="${star1 != 0}"></div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <p class="score_people_num">
                <strong th:text="${people}"></strong>명이 평가함
            </p>
        </div>
        <div class="review_input_right">
            <div class="star_tip_wrapper">
                <th:block th:if="${myReview == null}">
                    <p class="tip_title">이 책을 평가해주세요!</p>
                    <div class="star_rate_touch_area">
                        <fieldset>
                            <input type="radio" name="star" value="5" id="rate1"><label for="rate1">★</label>
                            <input type="radio" name="star" value="4" id="rate2"><label for="rate2">★</label>
                            <input type="radio" name="star" value="3" id="rate3"><label for="rate3">★</label>
                            <input type="radio" name="star" value="2" id="rate4"><label for="rate4">★</label>
                            <input type="radio" name="star" value="1" id="rate5"><label for="rate5">★</label>
                        </fieldset>
                    </div>
                </th:block>
                <th:block th:if="${myReview != null}">
                    <p class="tip_title">내가 남긴 별점
                        <span class="rate_num" th:text="|${myReview.star}.0|"></span></p>
                    <div class="star_rate_touch_area">
                        <fieldset>
                            <input type="radio" name="star" value="5" id="star1"
                                   th:checked="${myReview.star eq 5}"><label for="star1">★</label>
                            <input type="radio" name="star" value="4" id="star2"
                                   th:checked="${myReview.star eq 4}"><label for="star2">★</label>
                            <input type="radio" name="star" value="3" id="star3"
                                   th:checked="${myReview.star eq 3}"><label for="star3">★</label>
                            <input type="radio" name="star" value="2" id="star4"
                                   th:checked="${myReview.star eq 2}"><label for="star4">★</label>
                            <input type="radio" name="star" value="1" id="star5"
                                   th:checked="${myReview.star eq 1}"><label for="star5">★</label>
                        </fieldset>
                    </div>
                </th:block>
            </div>
            <textarea class="review_input_textarea"
                      placeholder="리뷰 작성 시 광고 및 욕설, 비속어나 타인을 비방하는 문구를 사용하시면 비공개될 수 있습니다."></textarea>
            <th:block sec:authorize="isAuthenticated()">
                <input type="hidden" id="reviewer" th:value="${#authentication.principal.userindex}">
            </th:block>
            <div class="button_wrapper">
                <button type="submit" class="review_btn">리뷰 남기기</button>
            </div>
            <div class="modify_button_wrapper">
                <button type="submit" class="modify_btn hidden">수정완료</button>
                <button type="submit" class="modify_cancel_btn hidden">취소</button>
            </div>
            <th:block th:if="${myReview} != null">
                <div class="my_review">
                    <div class="review_content_wrapper">
                        <div class="my_review_date">
                            <p class="left_column"><span class="review_date" th:text="${myReview.regdate}"></span></p>
                            <div class="right_column">
                                <a th:onclick="'javascript:modifyReview()'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                         class="bi bi-pencil" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                    </svg>
                                </a>
                                <a th:onclick="|javascript:deleteReview('${myReview.reviewindex}')|">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                         class="bi bi-trash" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd"
                                              d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                        <p class="my_review_content" th:text="${myReview.reviewcontent}"></p>
                    </div>
                </div>
            </th:block>

        </div>
    </div>
    <div id="review_list_section">
        <div class="review_tab">
            <ul class="review_tab_2">
                <li class="tab_list">구매자 <span class="num" th:text="${people}"></span></li>
            </ul>
            <ul class="review_filter">
                <li class="filter_list"><a>최신순</a></li>
                <li class="filter_list"><a>별점 높은순</a></li>
                <li class="filter_list"><a>별점 낮은순</a></li>
            </ul>
        </div>
        <div class="review_list_wrapper">
            <th:block th:if="${people}==0">
                <div class="review_list_empty">
                    <p>아직 등록된 리뷰가 없습니다.<br>첫 번째 리뷰를 남겨주세요!</p>
                </div>
            </th:block>
            <ul>
            </ul>
            <div class="more_review_button_wrapper" id="example">
                <button type="button" class="more_review_button">더보기</button>
            </div>
        </div>
    </div>
</article>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script th:inline="javascript">
    var isbn = [[${bookView.isbn}]]
    var loginInfo = [[${loginInfo}]]
    var myReview = [[${myReview}]]
    var page = 1
</script>
<script src="/js/review.js"></script>

<!--도서 상세 관련 script -->
<script th:inline="javascript">

    let price = [[${bookView.saleprice}]]
    const isbnisbn = [[${bookView.isbn}]]
    let qty = 0

    function count(type) {
        // 결과를 표시할 element
        const resultEl = document.getElementById('result');
        const resultTotal = document.getElementById('totalPrice');
        const dirQty = document.getElementById('dirQty');

        // 현재 화면에 표시된 값
        let number = resultEl.value;

        console.log('resultEl.value ==> ', resultEl.value);
        console.log('type ==> ', type);

        // 더하기/빼기
        if (type === 'plus') {
            number = parseInt(number) + 1;
        } else if (type === 'minus') {
            number = parseInt(number) - 1;
            if (number < 1) {
                return;
            }
        }

        // 결과 출력
        resultEl.value = number;
        dirQty.value = number;
        resultTotal.innerText = (price * number).toLocaleString() + '원';
        console.log('dirQty.value ==> ', dirQty.value);
        dirQty.setAttribute('href', '/order?isbn=' + isbnisbn + '&bookcount=' + number);
        qty = number;

    }

    function insertOneCart(dat) {

        console.log('isbn ===> ', dat.value);

        let payload = {
            userindex: 1,
            isbn: dat.value,
            bookcount: qty
        }

        console.log('payload => ', payload);

        $.ajax({
            url: '/cart',
            type: 'post',
            data: JSON.stringify(payload),
            dataType: 'json',
            contentType: 'application/json',
            success: function (res) {
                console.log('카트 등록 성공!!!');
                if (confirm("장바구니로 이동하시겠니까?")) {
                    location.href = '/view/book/bookMainList'; /*임시 링크*/
                }
            },
            error: function (error) {
                console.log("카트 등록 실패!!", error);
                alert('이미 카트에 담겨 있는 도서들입니다.');
            }
        });
    }
</script>

</body>
</html>


