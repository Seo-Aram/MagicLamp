<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Board Main List</title>
    <script src="https://code.jquery.com/jquery-1.12.4.js"
            integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU=" crossorigin="anonymous"></script>

    <style>
        /* Customized Paging */
        .pg_wrap {
            clear: both;
            text-decoration: none;
        }

        .pg_page { /* 기본페이지 */
            width: 30px !important;
            height: 30px !important;
            font-size: 13px;
            color: #333;
            line-height: 33px;
            padding: 0;
            background: #fff;
            border: 0;
            border-radius: 2px;
            -moz-border-radius: 2px;
            -webkit-border-radius: 2px;
            text-align: center;
            display: inline-block;
        }

        .pg_page:hover {
            background: #f2f2f2;
        }

        .pg_current { /* 현재페이지 */
            width: 30px !important;
            height: 30px !important;
            font-size: 13px;
            color: white;
            font-weight: normal;
            line-height: 33px;
            margin: 0;
            padding: 0;
            background: antiquewhite;
            border: 0;
            border-radius: 2px;
            -moz-border-radius: 2px;
            -webkit-border-radius: 2px;
            text-align: center;
            display: inline-block;
        }

        .pg_start { /* 처음 */
            position: relative;
            top: 50%;
            width: 28px !important;
            height: 28px !important;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 2px;
            -moz-border-radius: 2px;
            -webkit-border-radius: 2px;
            text-indent: -9999px;
            display: inline-block;
        }

        .pg_start:after {
            position: absolute;
            top: 10px;
            left: 10px;
            content: "";
            width: 6px;
            height: 6px;
            border-top: 1px solid transparent;
            border-right: 1px solid transparent;
            border-bottom: 1px solid #777;
            border-left: 1px solid #777;
            transform: rotate(45deg);
        }

        .pg_start:before {
            position: absolute;
            top: 10px;
            left: 16px;
            content: "";
            width: 6px;
            height: 6px;
            border-top: 1px solid transparent;
            border-right: 1px solid transparent;
            border-bottom: 1px solid #777;
            border-left: 1px solid #777;
            transform: rotate(45deg);
        }

        .pg_start:hover {
            background: #fff;
            border: 1px solid #333;
        }

        .pg_prev { /* 이전 */
            position: relative;
            top: 50%;
            width: 28px !important;
            height: 28px !important;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 2px;
            -moz-border-radius: 2px;
            -webkit-border-radius: 2px;
            text-indent: -9999px;
            display: inline-block;
        }

        .pg_prev:after {
            position: absolute;
            top: 10px;
            left: 13px;
            content: "";
            width: 6px;
            height: 6px;
            border-top: 1px solid transparent;
            border-right: 1px solid transparent;
            border-bottom: 1px solid #777;
            border-left: 1px solid #777;
            transform: rotate(45deg);
        }

        .pg_prev:hover {
            background: #fff;
            border: 1px solid #333;
        }

        .pg_next { /* 다음 */
            position: relative;
            top: 50%;
            width: 28px !important;
            height: 28px !important;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 2px;
            -moz-border-radius: 2px;
            -webkit-border-radius: 2px;
            text-indent: -9999px;
            display: inline-block;
        }

        .pg_next:after {
            position: absolute;
            top: 10px;
            right: 13px;
            content: "";
            width: 6px;
            height: 6px;
            border-top: 1px solid #777;
            border-right: 1px solid #777;
            border-bottom: 1px solid transparent;
            border-left: 1px solid transparent;
            transform: rotate(45deg);
        }

        .pg_next:hover {
            background: #fff;
            border: 1px solid #333;
        }

        .pg_end { /* 맨끝 */
            position: relative;
            top: 50%;
            width: 28px !important;
            height: 28px !important;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 2px;
            -moz-border-radius: 2px;
            -webkit-border-radius: 2px;
            text-indent: -9999px;
            display: inline-block;
        }

        .pg_end:after {
            position: absolute;
            top: 10px;
            right: 10px;
            content: "";
            width: 6px;
            height: 6px;
            border-top: 1px solid #777;
            border-right: 1px solid #777;
            border-bottom: 1px solid transparent;
            border-left: 1px solid transparent;
            transform: rotate(45deg);
        }

        .pg_end:before {
            position: absolute;
            top: 10px;
            right: 16px;
            content: "";
            width: 6px;
            height: 6px;
            border-top: 1px solid #777;
            border-right: 1px solid #777;
            border-bottom: 1px solid transparent;
            border-left: 1px solid transparent;
            transform: rotate(45deg);
        }

        .pg_end:hover {
            background: #fff;
            border: 1px solid #333;
        }
    </style>

    <link href="/css/review.css" rel="stylesheet">
</head>
<body>
<!--내비게이션 시작-->
<!--내비게이션 끝-->

<!--도서 검색바 시작-->
<table style="margin-left:auto; margin-right:auto;">
    <tr>
        <td>
            <div style="text-align: center">
                <form>
                    검색:
                    <select name="searchType">
                        <option value="isbn">ISBN</option>
                        <option value="title">도서명</option>
                    </select>
                    <input type="text" name="keyword">
                    <input type="submit" value="검색">
                </form>
            </div>
        </td>
    </tr>
</table>

<!--도서 검색바 끝-->

<!--페이징(상부) 시작-->
<table style="margin-left:auto; margin-right:auto;">
    <Tr>
        <Td>
            <nav class="pg_wrap">
                <ul>
                    <th:block th:if="${BookMainListPage.prev}">
                        <li class="pg_page">
                            <a th:href="@{/view/book/bookMainList(p=${BookMainListPage.startnum-1})}">PREV</a>
                        </li>
                    </th:block>
                    <th:block th:each="num : ${#numbers.sequence(BookMainListPage.startnum, BookMainListPage.endnum)}"
                              th:with="active=${BookMainListPage.pagenum == num ? 'pg_current' : ''}">
                        <li th:classappend="${active}" class="pg_page">
                            <a th:href="@{/view/book/bookMainList(p=${num},searchType=${BookMainListPage.searchType},keyword=${BookMainListPage.keyword})}"
                               th:text="${num}"></a>
                        </li>
                    </th:block>
                    <th:block th:if="${BookMainListPage.next}">
                        <li class="pg_page">
                            <a th:href="@{/view/book/bookMainList(p=${BookMainListPage.endnum+1})}">NEXT</a>
                        </li>
                    </th:block>
                </ul>
            </nav>
        </Td>
    </Tr>
</table>
<!--페이징(상부) 끝-->

<!-- 도서 리스트 시작-->
<table style="margin-left:auto; margin-right:auto;">
    <tr>
        <td>
            <div style="display: inline">
                <input type="checkbox" name="checkBook" onclick="selectAll(this)"/><b>전체선택</b>
            </div>
        </td>
        <td>
            <div style="display: inline">
                <button style="display: inline" onclick="insertAllCart()">장바구니 담기</button>
            </div>
        </td>
    </tr>
    <th:block th:each="book, bookStat : ${BookMainListPage.list}">
        <tr>
            <td colspan="4">
                <hr/>
            </td>
        </tr>
        <tr>
            <td width="5%" style="text-align: center">
                <div th:text="${bookStat.count} + '.'"></div>
                <input type="checkbox" name="checkBook" th:value="${book.isbn}" id="checkBK">
            </td>
            <td width="10%">
                <a th:href="@{/view/book/bookView(isbn=${book.isbn},p=${BookMainListPage.pagenum})}">
                    <div th:if="${book.bookimg.length() > 0}">
                        <img th:src="@{/photo/{name}(name=${book.bookimg})}" height="200px">
                    </div>
                    <div th:unless="${book.bookimg.length() > 0}">
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAADICAMAAAA9W+hXAAAAQlBMVEX9/f3///++vr7f39/j4+Pb29ugoKDBwcHv7+9+fn7Hx8fOzs7KysrS0tL39/fz8/OHh4eYmJiPj4+xsbGpqanp6elktXx4AAAEtUlEQVR4nO2bC2/rKBBGMW/ztJ3L//+rOwMkdpLuStWujVeao6vWl6TyEXwehqhljCAIgiAIgiAIgiAIgiAIgiAIgiAIgiB+j82jDb6RkXN+Ny/pOHeB29Eeb6BUtJO4lZZFqTRN47SSrRwjlCBTPk1JpCFaSUaYlSfOq+ZmDXdlQjcJWtxFma6Uqko+ikr0BtUkY4pzxRj6SFzEUJXPE5s+sHDffBxIBSYoBG7sVBw3cmrZmjLE337+9HSOVhKKi697JQ9ijEWcsOmphV+VSFdoZVwy0JLR11UK3ouCd+acZccdyCRlCgj5upScm3yBluMxolaNF2Bq6iMOTB6nCsNlbBVCLXi3u0ALclUXMb/WJlnhq+eUYF4wXIKhUMl1ESFfF2p9gZMz7eF6ZetaLWZLKxDFppdWMTxYfI2BkGQDtMxeTrmJpWqp+jAwYeAbJmyAlhSibT5SQMX3Tcu1cOE6otDobKXUs1Xrl0rjsvVF1ZIQrlamBmmp8ExWgHrKWoHwbecpPuOeqIZE3ndqYe3lNKQWrjIq8sf7FNGexCL3cN0qWzhJ3g7MVpZC4RJC19XqKWrl0MLVCumIzYcfcW1PLLVlnqxv3SkfoFWKrZUgwSbkTesgounhqk+iKvfJFrY1wY7LFs5TO/kcteA8Bi3gNE4rHJLlRdt88JAR4e25Hsh4GKAVnycfhQ1qK6exTtXzQBbi4Gyl0sqpxJ4ZZsyVu5XT8gzXIC2p6nYIX5SwrGu9HciG9Fu9eeipV1WrH8i61pByml/H5Qz1VO0HspeWvMvJJx0OqveK/GsK4/20ksDPdG6mlRSe/kvvum6iheW0nvanO2nB0WeXGqGFB1fEWvbSgu6U+/YhgLTXZ8srd2xO4bDPUEvwd5zyl2rVbiZGhcTo8PMIGMSSb9xr2Ff1q7SMFM4r+YZqn76Z73EnIG0XaEUO8/ENehn/0ysOPyo8XYt5/ks8u0ALN+lf8fGB7mla/xbSIi3SIi3SIi3SIq1xWgRB3B8tX5fG/jR6MWZZDHybFQsGCPslXMPlGMIS4F910doYrbvWYx6qpTljvLlomDXTLhlTM746TAtvjAqfWnHOd9R6zGGk1gZ3D9uXVl74lgdqPcBDPz618qrz+sjjtOyybYttWjNQtewKQ3JZx2mxbMxHuOGyVtQsB2rtLv98OYabaqm7/V488b9DqsbeSAX+PmqV7aOHN3TMWb89z7Xe5lVD4yA1/jfUwr6PMr7o5dHKfZeAS1v7L3vqk6ln7Pta6wIbDgpA7VyXP/g9LhLqe9z37Kql5rO17J8lLljYj1o2bKtatmCbZB89arUfPksr63mF6VhnndWstV6qQF42g9vQNue/m62uZU7yCi3rMsCtIONr1ZKxRz5K9tiz9YPWqk+xgmx3+GERcXSd6+jzSVThykWslQCWAmrBR+TN85b4Vw+tKmDjpYJ6aql4XuT3WThkCyOH8/XAjREPQP0INM+L/tO0AGgNT9Pa61GuaWrPnsEOmWUM/kHr8COd87RW1XWOdw3w7DF4CnH99ANff1yrFXriw/tdw4oNcx3sTwV/f8PJWgRBEARBEARBEARBEARBEARBEARBEATxX/AXA2NChMzAFEkAAAAASUVORK5CYII=" height="200px">
                    </div>
                </a>
            </td>
            <td width="65%">
                <div>
                    <a th:text="${book.title}"
                       th:href="@{/view/book/bookView(isbn=${book.isbn},p=${BookMainListPage.pagenum})}"></a>
                </div>
                <div th:text="${book.author + ' | ' + book.publisher + ' | ' + book.pubdate}"></div>
                <div th:text="${#numbers.formatInteger(book.price, 0, 'COMMA')}" style="display: inline"></div>
                ->
                <div th:text="${#numbers.formatInteger(book.saleprice, 0, 'COMMA')} + ' (10% 할인)'"
                     style="display: inline"></div>
                <div th:text="${', 마일리지: ' + #numbers.formatInteger((book.price*book.mileagerate/100), 0, 'COMMA') + '원 (' + book.mileagerate + '% 적립)'}"
                     style="display: inline"></div>
                <div>
                    <th:block th:if="${book.star > 0}">
                        <th:block th:if="${book.star == 5}">★★★★★</th:block>
                        <th:block th:if="${book.star == 4}">★★★★☆</th:block>
                        <th:block th:if="${book.star == 3}">★★★☆☆</th:block>
                        <th:block th:if="${book.star == 2}">★★☆☆☆</th:block>
                        <th:block th:if="${book.star == 1}">★☆☆☆☆</th:block>
                        <a th:text="${'(' + book.cnt + ')'}"
                           th:href="@{/view/book/bookView(isbn=${book.isbn},p=${BookMainListPage.pagenum})}"></a>
                    </th:block>
                </div>
            </td>
            <td width="20%" style="text-align: center">
                <div>
                    <!--                    <button onclick="insertOneCart()">장바구니 담기</button>-->
                    <button onclick="insertOneCart(this)" th:value="${book.isbn}">장바구니 담기</button>
                    <input type="hidden" th:value="${book.isbn}">
                </div>
                <div>
                    <a class="btn_buy"
                       th:href="@{/order(isbn=${book.isbn}, bookcount=${1})}"> 바로 구매 </a>
                </div>
            </td>
        </tr>
    </th:block>
    <tr>
        <td>
            <div style="display: inline">
                <input type="checkbox" name="checkBook" onclick="selectAll(this)"/><b>전체선택</b>
            </div>
        </td>
        <td>
            <div style="display: inline">
                <button style="display: inline" onclick="insertAllCart()">장바구니 담기</button>
            </div>
        </td>
    </tr>
</table>
<div id='result'></div>
<!-- 도서 리스트 끝-->

<!--페이징(하부) 시작-->
<table style="margin-left:auto; margin-right:auto;">
    <Tr>
        <Td>
            <nav class="pg_wrap">
                <ul>
                    <th:block th:if="${BookMainListPage.prev}">
                        <li class="pg_page">
                            <a th:href="@{/view/book/bookMainList(p=${BookMainListPage.startnum-1})}">PREV</a>
                        </li>
                    </th:block>
                    <th:block th:each="num : ${#numbers.sequence(BookMainListPage.startnum, BookMainListPage.endnum)}"
                              th:with="active=${BookMainListPage.pagenum == num ? 'pg_current' : ''}">
                        <li th:classappend="${active}" class="pg_page">
                            <a th:href="@{/view/book/bookMainList(p=${num},searchType=${BookMainListPage.searchType},keyword=${BookMainListPage.keyword})}"
                               th:text="${num}"></a>
                        </li>
                    </th:block>
                    <th:block th:if="${BookMainListPage.next}">
                        <li class="pg_page">
                            <a th:href="@{/view/book/bookMainList(p=${BookMainListPage.endnum+1})}">NEXT</a>
                        </li>
                    </th:block>
                </ul>
            </nav>
        </Td>
    </Tr>
</table>
<!--페이징(하부) 끝-->

<script th:inline="javascript">

    $(document).ready(function () {



    })

    function selectAll(selectAll) {
        const checkBooks = document.getElementsByName('checkBook');

        const list = []

        checkBooks.forEach((checkbox) => {
            checkbox.checked = selectAll.checked;

            if (checkbox.value != 'on') {
                list.push(checkbox.value)
            }

        })

        console.log(list);
    }

    function insertAllCart() {

        // 선택된 목록 가져오기
        const query = 'input[name="checkBook"]:checked';
        const selectedEls = document.querySelectorAll(query);

        const booklist = []

        let payload = null;
        // 선택된 목록에서 value 찾기
        selectedEls.forEach((el) => {
            result += el.value + ' ';

            if (el.value != 'on') {

                payload = {
                    userindex: 1,
                    isbn: el.value,
                    bookcount: 1
                }

                booklist.push(payload)

                console.log('payload => ', payload);

            }
        });

        console.log('booklist => ', booklist);

        $.ajax({
            url: '/cart/select',
            type: 'post',
            data: JSON.stringify(booklist),
            dataType: 'json',
            contentType: 'application/json',
            success: function (res) {
                console.log('카트 등록 성공!!!');
                if (confirm("장바구니로 이동하시겠니까?")) {
                    location.href = '/view/book/bookMainList'; /*임시 링크*/
                }
            },
            error: function (error) {
                console.log("카트 등록 실패!!", error);
                alert('이미 카트에 담겨 있는 도서들입니다.');
            }
        });
    }

    function insertOneCart(dat) {

        console.log('isbn ===> ', dat.value);

        let payload = {
            userindex: 1,
            isbn: dat.value,
            bookcount: 1
        }

        console.log('payload => ', payload);

        $.ajax({
            url: '/cart',
            type: 'post',
            data: JSON.stringify(payload),
            dataType: 'json',
            contentType: 'application/json',
            success: function (res) {
                console.log('카트 등록 성공!!!');
                if (confirm("장바구니로 이동하시겠니까?")) {
                    location.href = '/view/book/bookMainList'; /*임시 링크*/
                }
            },
            error: function (error) {
                console.log("카트 등록 실패!!", error);
                alert('이미 카트에 담겨 있는 도서들입니다.');
            }
        });
    }


</script>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


</body>
</html>