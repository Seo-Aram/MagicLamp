<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="/css/order.css" rel="stylesheet">
    <title>주문 페이지</title>
</head>
<body>

  <h1>주문 페이지</h1>

  <div id="order_div">

      [[${loginInfo}]]
      <br>
      [[${ordersInfo}]]
      <br>

    <!------------ 주문서 테이블 영역 시작 -------------->

    <table>

      <!------------상품 정보 확인 영역 -------------->

      <div>
          <div class="bookinfo_div">
              <h3> 주문 상품 정보 </h3>
              <table style="background-color: #a2a2a2">
                  <tr class="infohead">
                      <td> 제목 </td>
                      <td> 가격 / 적립금 </td>
                      <td> 수량 </td>
                      <td> 합계 </td>
                  </tr>
                  <tr class="infobody" th:each=" book : ${ordersInfo.bookInfos}">
                      <td class="data_td">
                          <a th:href="@{view/book/bookView(isbn=${book.isbn},p=${1})}" th:text="${book.title}"/>
                      </td>
                      <td> [[${#numbers.formatInteger(book.saleprice, 0, 'COMMA')}]] 원 / [[${#numbers.formatInteger(book.saveMileage, 0, 'COMMA')}]] 원 </td>
                      <td th:text="${book.bookcount}"/>
                      <td th:text="${#numbers.formatInteger(book.totalPrice, 0, 'COMMA')}"> 원 </td>
                  </tr>
              </table>
          </div>
      </div>

      <!------------배송지 정보 영역 -------------->

      <div>
          <div class="addinfo_div">
              <h3> 배송 정보 확인 </h3>
              <table>
                  <th:block th:each="user : ${ordersInfo}">
                      <tr>
                        <th class="popup"> 주문인 </th>
                        <td class="data_td">
                          <input th:value="${user.recipient}">
                        </td>
                      </tr>
                      <!-------------------------->
                      <tr>
                        <th class="popup"> 주소 </th>
                        <td class="data_td">
                          <div>
                          <span>
                            <input type="text" th:value="${user.postnum}">
                            <button> 주소 검색 </button>
                          </span>
                          </div>
                          <div>
                            <input type="text" th:value="${user.address1}">
                            <input type="text" th:value="${user.address2}">
                          </div>
                        </td>
                      </tr>
                      <!-------------------------->
                      <tr>
                        <th class="popup"> 연락처 </th>
                        <td class="data_td"> <input type="text" th:value="${user.phone}"> </td>
                      </tr>
                  </th:block>
              </table>
          </div>
      </div>

      <!------------마일리지 정보 영역 -------------->

      <div>
          <div class="miluse_div">
              <h3> 마일리지 사용하기 </h3>
              <table>
                  <th:block th:each="mm : ${ordersInfo}">
                      <tr>
                          <th class="popup">
                              <label> 보유한 마일리지 </label>
                          </th>
                          <td class="data_td">
                              <strong class="input_my_mileage" id="my_mileage" th:text="${#numbers.formatInteger(mm.mileage, '0', 'COMMA')}"/>
                          </td>
                          <td class="data_td">
                              <span> <input type="text" name="usemil" th:value="${0}" placeholder="사용할 금액"> </span>
                              <button class="usemil_btn"> 사용하기 </button>
                          </td>
                      </tr>
                  </th:block>
              </table>
          </div>
      </div>

      <!------------결제 금액 확인 영역 -------------->

      <div>
          <div class="payinfo_div">
              <h3> 결제 정보 </h3>
              <table>
                  <th:block th:each=" b : ${ordersInfo}">
                      <tr>
                          <th class="popup">수량</th>
                          <td class="data_td">
                              <p> 총 [[${b.totalBookCnt}]] 권 </p>
                          </td>
                      </tr>
                      <!-------------------------->
                      <tr>
                          <th class="popup"> 결제 예상 금액 </th>
                          <td class="data_td">
                              <strong th:text="${#numbers.formatInteger(b.orderTotalPrice, '0', 'COMMA')}"/> 원
                          </td>
                      </tr>
                      <!-------------------------->
                      <tr>
                          <th class="popup">적립 예정 마일리지</th>
                          <td class="data_td">
                              <strong name="saveMileage" th:text="${#numbers.formatInteger(b.totalSaveMileage, '0', 'COMMA')}"/> 점
                          </td>
                      </tr>
                      <!-------------------------->
                      <tr>
                          <th class="popup">할인 금액</th>
                          <td class="data_td">
                              <strong id="used_mileage" th:text="${#numbers.formatInteger(0, '0', 'COMMA')}"/> 원
                          </td>
                      </tr>
                      <!-------------------------->
                      <tr>
                          <th class="popup"> 결제 금액 </th>
                          <td class="data_td">
                              <strong id="calPrice" th:text="${#numbers.formatInteger(b.orderTotalPrice, '0', 'COMMA')}"/> 원
                          </td>
                      </tr>

                  </th:block>
              </table>
              <!-------------------------->
              <div th:each="pay : ${ordersInfo}">
                  <p> 결제하실 금액은 총 <strong id="resultPrice" th:text="${#numbers.formatInteger(pay.orderTotalPrice, '0', 'COMMA')}"/> 원 입니다.</p>
              </div>
          </div>
      </div>

    </table>

    <!------------버튼 영역 -------------->

    <div class="orderbtn_div">
      <button class="btn order_btn" type="submit"> 결제하기 </button>
      <button th:onclick="|location.href='@{/}'|">주문 취소</button>
    </div>

  </div>


  <!--order 요청시 보낼 form-->
  <form class="order_form" action="/order/payment" method="post">

      <th:block th:each="order, stat : ${ordersInfo.bookInfos}" >
          <input th:name="'bookInfos['+${stat.index}+'].isbn'" th:value="${order.isbn}" type="hidden">
          <input th:name="'bookInfos['+${stat.index}+'].bookcount'" th:value="${order.bookcount}" type="hidden">
          <input th:name="'bookInfos['+${stat.index}+'].saleprice'" th:value="${order.saleprice}" type="hidden">
          <input th:name="'bookInfos['+${stat.index}+'].totalPrice'" th:value="${order.totalPrice}" type="hidden">
          <input th:name="'bookInfos['+${stat.index}+'].saveMileage'" th:value="${order.saveMileage}" type="hidden">
          <input th:name="'bookInfos['+${stat.index}+'].totalMileage'" th:value="${order.totalMileage}" type="hidden">
      </th:block>

      <input name="usemileage" type="hidden">

      <input name="mileage" th:value="${ordersInfo.mileage}" type="hidden">
      <input name="recipient" th:value="${ordersInfo.recipient}" type="hidden">
      <input name="postnum" th:value="${ordersInfo.postnum}" type="hidden">
      <input name="address1" th:value="${ordersInfo.address1}" type="hidden">
      <input name="address2" th:value="${ordersInfo.address2}" type="hidden">
      <input name="phone" th:value="${ordersInfo.phone}" type="hidden">

      <input name="totalBookCnt" th:value="${ordersInfo.totalBookCnt}" type="hidden">
      <input name="totalSaveMileage" th:value="${ordersInfo.totalSaveMileage}" type="hidden">
      <input name="orderTotalPrice" th:value="${ordersInfo.orderTotalPrice}" type="hidden">

      <input name="userindex" th:value="${loginInfo}" type="hidden">


  </form>

  <script src="/js/order.js"></script>
  <script th:inline="javascript">
      var loginInfo = [[${loginInfo}]]
      let totalPrice = [[${ordersInfo.orderTotalPrice}]]
      let myMileage = [[${ordersInfo.mileage}]]
  </script>

</body>
</html>


